#!/usr/bin/env python3

import sys

from sync_hooks import maybe_run_sync, parse_state_dir


def stdin_has_changes() -> bool:
    """Drain stdin and report whether Taskwarrior sent any modified tasks."""
    has_input = False
    for _ in sys.stdin:
        has_input = True
    return has_input


def main() -> int:
    if not stdin_has_changes():
        return 0
    try:
        state_dir = parse_state_dir(sys.argv)
    except ValueError as error:
        _ = sys.stderr.write(f"{error}\n")
        return 1
    return maybe_run_sync(
        state_dir=state_dir,
        filestamp_name=".last-on-exit-sync",
        lock_name=".on-exit-sync.lock",
    )


if __name__ == "__main__":
    raise SystemExit(main())
